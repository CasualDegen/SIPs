---
sip: 258
title: Update To Atomic Exchange Function
network: Ethereum
status: Draft
type: Governance
author: Kaleb (@kaleb-keny)
created: 2022-07-05
---

## Simple Summary

<!--"If you can't explain it simply, you don't understand it well enough." Simply describe the outcome the proposed changes intends to achieve. This should be non-technical and accessible to a casual community member.-->

Update the atomic exchange functionality, laid out in [SIP-120](https://sips.synthetix.io/sips/sip-120/) and recently updated in [SIP-198](https://sips.synthetix.io/sips/sip-198/), as to incorporate the bid/ask element of the uniswap spot/twap pricing.

## Abstract

The SIP proposes to incorporate the bid/ask aspects into the atomic exchange functionality, while the current atomic exchange functionality only relies on the ask side.

## Motivation

Incorporating the proper bid/ask functionality into the atomic exchange functionality allows trading to persists for longer periods at near-exchange prices.

## Specification

<!--The specification should describe the syntax and semantics of any new feature, there are five sections
1. Overview
2. Rationale
3. Technical Specification
4. Test Cases
5. Configurable Values
-->

### Overview

<!--This is a high level overview of *how* the SIP will solve the problem. The overview should clearly describe how the new feature will be implemented.-->

### Rationale

<!--This is where you explain the reasoning behind how you propose to solve the problem. Why did you propose to implement the change in this way, what were the considerations and trade-offs. The rationale fleshes out what motivated the design and why particular design decisions were made. It should describe alternate designs that were considered and related work. The rationale may also provide evidence of consensus within the community, and should discuss important objections or concerns raised during discussion.-->

### Technical Specification

<!--The technical specification should outline the public API of the changes proposed. That is, changes to any of the interfaces Synthetix currently exposes or the creations of new ones.-->

#### Atomic Price Computation Methodology

##### Context on Pricing and Naming Conventions

##### Computation Methodology in Atomic Pricing

- When `SourceCurrency` and `DestinationCurrency` are both set to trade at the PureChainlinkPrice, in such a case, both `chainlink(Src/USD)` and `chainlink(Dest/USD)` are used to compute `Src/Dest` by dividing `chainlink(Src/USD)` by `chainlink(Dest/USD)`.

- `SourceCurrency` is **NOT** set to PureChainlinkPrice and `Dest` is set to PureChainlinkPrice, in such a situation we need to fetch 3 different prices `Uni(Src/USD)`, `Chainlink(Src/USD)` and `Chainlink(Dest/USD)`. 

`Uni(Src/USD)` is obtained with the following:
  1) fetch the twap price of the `sourceCurrency` from the relevant uniswap pool. Call this price `sourceTwap`
  2) fetch the spot "bid" price, at the begining of the block from the relevant uniswap pool. The bid-price is the price of swapping the `sourceCurrency` to `USD`. Call this price `sourceSpot`
  3) `Uni(Src/USD)` being computed by `min(sourceTwap,sourceSpot)`

`Chainlink(Src/USD)` and `Chainlink(Dest/USD)` are simply the chainlink rates for the `sourceCurrency` and `destinationCurrency`

`SRC/DEST` is obtained with the following  `min(Uni(SRC/USD),chainlink(SRC/USD)) / chainlink(DEST/USD)`.

- `SourceCurrency` is set to PureChainlinkPrice and `DestinationCurrency` is **NOT** set to PureChainlinkPrice, in such a situation we need to fetch 3 different prices `Uni(Dest/USD)`, `Chainlink(SRC/USD)` and `Chainlink(Dest/USD)`. 

`Uni(Dest/USD)` is obtained with the following:
  1) fetch the twap price of the `destinationCurrency` from the relevant uniswap pool. Call this price `destinationTwap`
  2) fetch the spot "ask" price, at the begining of the block from the relevant uniswap pool. The ask-price is the price of swapping the `USD` to the `sourceCurrency`. Call this price `destinationSpot`
  3) `Uni(Dest/USD)` being computed by `max(destinationTwap,destinationSpot)`

Chainlink prices are identical to the ones obtained in the previous case.

`SRC/DEST` is obtained with the following  `chainlink(SRC/USD) /  max(Uni(Dest/USD),chainlink(Dest/USD))`

- Both `SourceCurrency` and `DestinationCurrency` are **NOT** set to PureChainlinkPrice, in such a situation we need to fetch 4 different prices `Uni(Src/USD)`, `Uni(Dest/USD)`, `Chainlink(SRC/USD)` and `Chainlink(Dest/USD)`. 

All the price elements are identical to those computed in the previous 2 cases, with the `Src/Dest` obtained with `min[Uni(SRC/USD),chainlink(SRC/USD)] / max[Uni(Dest/USD),chainlink(Dest/USD)]`.

### Test Cases

<!--Test cases for an implementation are mandatory for SIPs but can be included with the implementation..-->

### Configurable Values (Via SCCP)

<!--Please list all values configurable via SCCP under this implementation.-->

Aside from the SCCP configurable variables specified in [SIP-120](https://sips.synthetix.io/sips/sip-120/), the Spartan Council can assign that an asset can be traded at the pure chainlink price via SIP with `setPureChainlinkPriceForAtomicSwapsEnabled`.

## Copyright

Copyright and related rights waived via [CC0](https://creativecommons.org/publicdomain/zero/1.0/).
